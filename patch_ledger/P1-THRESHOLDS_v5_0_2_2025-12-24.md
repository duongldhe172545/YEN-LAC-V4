# P1-THRESHOLDS (V5.0.2) — Khóa ngưỡng cảnh báo & kill-switch

**Patch ID:** P1-THRESHOLDS  
**Version:** V5.0.2  
**Build date:** 2025-12-24 (Asia/Bangkok)  
**Mục tiêu:** Khóa `registry/thresholds.yaml` để Go-live có **màu cảnh báo** (GREEN/YELLOW/RED) và **hành động** (Warning/Throttle/Hard Stop) theo A8 Runbook.

## 1) Files (đúng chỗ để khỏi loạn)
- **Machine registry (SSOT):** `d2com-pilot-yen-lac/registry/thresholds.yaml`
- **Patch record (audit):** `d2com-pilot-yen-lac/patch_ledger/P1-THRESHOLDS_v5_0_2_2025-12-24.md`
- **Decision log:** `d2com-pilot-yen-lac/patch_ledger/patch_decision_log.md` (append entry)

## 2) Invariants (bất biến)
1. `metric_code` phải tồn tại trong `registry/metrics.csv`.
2. Metric có `kill_switch=true` phải có rule `TIER_3_HARD_STOP`.
3. Mọi rule phải trỏ tới `registry/runbook_actions.yaml` qua `action_tier`.
4. Append-only: thay đổi ngưỡng = patch mới + decision log.

## 3) Chính sách ngưỡng
- **LOCKED tuyệt đối:** `unconsented_pii_risk` ngưỡng = 0 (mọi vi phạm → quarantine + hard stop).
- **PROVISIONAL:** phần lớn ngưỡng còn lại là ngưỡng khởi tạo, cần hiệu chỉnh sau **baseline 14 ngày** (due: 2026-01-07).
- Ngưỡng có thể tham chiếu metric khác (ví dụ OPEX so với budget) bằng `value_ref`.

## 4) Smoke tests (pass/fail)
- Join-check: mọi `thresholds[].metric_code` ∈ `metrics.csv`.
- Kill-check: nếu `kill_switch=true` thì phải có `TIER_3_HARD_STOP`.
- Action-check: mọi `tiers[].action_tier` có tồn tại trong `runbook_actions.yaml`.
- Parse-check: YAML hợp lệ, không key trùng.

## 5) Rollback (quay lui)
**Điều kiện rollback:** phát hiện set ngưỡng sai gây hard-stop giả hoặc bỏ lọt gian lận.  
**Cách làm:**
1. `git revert <commit_hash>`
2. deploy lại image/registry version trước
3. chạy lại smoke tests mục (4) trong 15 phút

**Owner:** Data Lead (HO) + Commander (HO)

## 6) Training/Drill
- Drill Tier-2 Throttle: 1 lần trước go-live + 1 lần/tuần (tuần 1–4).
- Drill Tier-3 Hard Stop + rollback: 1 lần trước go-live + 1 lần/tháng.

